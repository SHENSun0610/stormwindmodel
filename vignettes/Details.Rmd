---
title: "Details of `stormwindmodel` package"
author: "G. Brooke Anderson, Andrea Schumacher, Seth Guikema, Joshua M. Ferreri, Steven Quiring"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: bibliography.bib
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r echo = FALSE, message = FALSE}
library(stormwindmodel)
library(hurricaneexposure)
library(hurricaneexposuredata)
library(ggplot2)
library(dplyr)
library(tidyr)
library(gridExtra)
library(ggthemes)
```

## Overview of wind modeling process

Here is an overview of the wind modeling process implemented by this package: 

1. Impute location and maximum wind speed from hurricane track data (every 6 hours) to more frequent intervals. The default is to impute to every 15 minutes.
2. For each storm track location, calculate all the inputs needed for the Willoughby wind speed model (forward speed, direction of forward motion of the storm, gradient-level wind speed, radius of maximum winds, parameters for decay of winds away from the storm's center for Willoughby model) [@willoughby2006parametric]. 
3. For each county center (or other grid point), estimate surface-level sustained wind and 3-second wind gusts at all storm observation points (i.e., all points along the interpolated storm track). This step includes: measuring distance to county from storm center (radius); calculating tangential gradient wind components at that grid point; calculating gradient wind direction at that grid point; calculating surface wind speed; calculating surface wind direction, adding storm forward motion back into surface wind estimate.
4. Determine for each county: the maximum sustained winds and wind gust speeds at any point on the storm's track; the duration of sustained and gust winds over a certain speed (i.e., how many minutes winds were above a cutoff).

This process is conducted in the `stormwindmodel` package using three main functions: `create_full_track`, `add_wind_radii`, and `calc_grid_wind`. Each of these functions has a number of helper functions to do each required modeling step. Details of all of these are included in this vignette. The full process is then wrapped in the `get_grid_winds` function, which is the main function most people will use from this package. 

## Variable definitions

Here are variables used in this modeling process. 

```{r echo = FALSE}
var_names <- dplyr::data_frame(var = c("`vmax`",
                                       "`vmax_sfc_sym`",
                                       "`vmax_gl`",
                                       "`tclat`",
                                       "`tclon`",
                                       "`Rearth`",
                                       "`tcspd`",
                                       "`tcspd_u`", 
                                       "`tcspd_v`",
                                       "`tcdir`",
                                       "`X1`",
                                       "`X2`",
                                       "`n`",
                                       "`A`",
                                       "`xi`",
                                       "`R1`",
                                       "`R2`",
                                       "`gwd`",
                                       "`beta`",
                                       "`swd`",
                                       "`Vi`",
                                       "`V0`",
                                       "`wind_gl_aa`",
                                       "`wind_gl`",
                                       "`cdist`",
                                       "`chead`",
                                       "`wind_sfc_sym_u`",
                                       "`wind_sfc_sym_v`",
                                       "`wind_sfc_u`",
                                       "`wind_sfc_v`",
                                       "`r`",
                                       "`Rmax`",
                                       "`reduction_factor`",
                                       "`windspeed`",
                                       "`gustspeed`",
                                       "`vmax_sust`",
                                       "`vmax_gust`",
                                       "`sust_dur`",
                                       "`gust_dur`",
                                       "`gust_factor`"),
                               math = c("$V_{max}$",
                                        "$V_{max,sym}$",
                                        "$V_{max,G}$",
                                        "$\\phi$",
                                        "$L$",
                                        "$R_{earth}$",
                                        "$V_F$",
                                        "$V_{F,u}$",
                                        "$V_{F,v}$",
                                        "$\\theta$",
                                        "$X_1$",
                                        "$X_2$",
                                        "$n$",
                                        "$A$",
                                        "$\\xi$",
                                        "$R_1$",
                                        "$R_2$",
                                        "?",
                                        "$\\beta$",
                                        "?",
                                        "$V_i$",
                                        "$V_0$",
                                        "$V_G(r)$",
                                        "?",
                                        "$C_{dist}$",
                                        "$C_{head}$",
                                        "$V_{sfc,sym,u}$",
                                        "$V_{sfc,sym,v}$",
                                        "$V_{sfc,u}$",
                                        "$V_{sfc,v}$",
                                        "$r$",
                                        "$R_{max}$",
                                        "$f_r$",
                                        "$V_{sfc}$",
                                        "$V_{sfc,gust}$",
                                        "$V_{max,sust}$",
                                        "$V_{max,gust}$",
                                        "$T_{sust}$",
                                        "$T_{gust}$",
                                        "$G_{3,60}$"),
                               defn = c("Max 10-m 1-min sustained wind",
                                        "Max 10-m 1-min sustained wind with motion asymmetry removed",
                                        "Max gradient-level 1-min sustained wind",
                                        "Tropical cyclone center position latitude",
                                        "Tropical cyclone center position longitude (0 to 360)",
                                        "Radius of the earth",
                                        "Tropical cyclone forward speed",
                                        "Tropical cyclone forward speed, u-component",
                                        "Tropical cyclone forward speed, v-component",
                                        "Tropical cyclone forward direction",
                                        "Parameter for Willoughby model",
                                        "Parameter for Willoughby model",
                                        "Parameter for Willoughby model",
                                        "Parameter for Willoughby model",
                                        "Parameter for Willoughby model",
                                        "Lower boundary of the transition zone for Willoughby model",
                                        "Upper boundary of the transition zone for Willoughby model",
                                        "Gradient wind direction",
                                        "Inflow angle (0 to 360)",
                                        "Surface wind direction",
                                        "Azimuthal average winds inside $R_1$",
                                        "Azimuthal average winds outside $R_2$",
                                        "Azimuthal average winds, varies by radius $r$", 
                                        "Gradient level winds (u, v) at grid point",
                                        "Distance from tropical cyclone to grid point",
                                        "Heading of grid point from tropical cyclone center",
                                        "Symmetric surface winds at grid point, u-component",
                                        "Symmetric surface winds at grid point, v-component",
                                        "Asymmetric surface winds at grid point, u-component",
                                        "Asymmetric surface winds at grid point, v-component",
                                        "Radius from the center of tropical cyclone",
                                        "Radius of maximum winds",
                                        "Reduction factor for converting between surface and gradient winds",
                                        "Asymmetric surface sustained wind at grid point",
                                        "Asymmetric surface wind gust at grid point",
                                        "Max 10-m 1-min sustained wind experienced at grid point",
                                        "Max 10-m 1-min gust wind experienced at grid point",
                                        "Duration of time a certain sustained wind was experienced at grid point",
                                        "Duration of time a certain gust wind was experienced at grid point",
                                        "10-m gust factor to convert from 1-min averaged mean wind to highest 3-sec mean (gust) within a 1-min observation period"),
                               units = c("m/s",
                                         "m/s",
                                         "m/s",
                                         "degrees North",
                                         "degrees East",
                                         "km",
                                         "m/s",
                                         "m/s",
                                         "m/s",
                                         "degrees (trigonomical)",
                                         "--",
                                         "--",
                                         "--",
                                         "--",
                                         "--",
                                         "km",
                                         "km",
                                         "degrees",
                                         "degrees",
                                         "degrees",
                                         "m/s",
                                         "m/s",
                                         "km",
                                         "degrees (trigonomical)",
                                         "m/s",
                                         "m/s",
                                         "m/s",
                                         "m/s",
                                         "m/s",
                                         "m/s",
                                         "km",
                                         "km",
                                         "--",
                                         "m/s",
                                         "m/s",
                                         "m/s",
                                         "m/s",
                                         "minutes",
                                         "minutes",
                                         "--"))
knitr::kable(var_names, col.names = c("R variable", "Expression in equations",
                                      "Definition", "Units"))
```

## Impute storm tracks

The tropical cyclone best tracks have observations every six hours (plus, for some, an observation at landfall). Our package has a function called `create_full_track` that imputes both locations (latitude and longitude) and intensity (maximum wind speed) from the hurricane tracks data to a finer time resolution (default is 15 minutes, but you can also select other values using the `tint` argument). This imputation uses a natural cubic spline, with the degrees of freedom set as the number of timed observations for the storm in the input data (typically best tracks data) divided by two. The option `tint` in this function gives the time interval you want to use, in hours (e.g., 0.25 for 15 minutes). 

```{r}
stormwindmodel::create_full_track
```

Here is an example of running this function like this, where `floyd_tracks` is a dataframe with the hurricane track information for Hurricane Floyd (saved as data with this package), and `tint` is the desired time interval to which to impute: 

```{r}
data("floyd_tracks")
full_track <- create_full_track(hurr_track = floyd_tracks, tint = 0.25)
full_track %>% slice(1:3)
```

## Add Willoughby inputs and parameters

The next step is to process this imputed track and add, for each observation point, the inputs and model parameters required for the Willoughby model [@willoughby2006parametric]. This process is done using the `add_wind_radii` function. As an input, it takes the imputed dataframe create by the `create_full_track` function. It outputs the same dataframe, but with columns added for the inputs and parameters required for the Willoughby wind model. 

For the Hurricane Floyd example, here is an example of running the code and the first three and last three line of output: 

```{r}
with_wind_radii <- stormwindmodel::add_wind_radii(full_track = full_track)
with_wind_radii %>% slice(c(1:3, (n()-3):n()))
```

This adds lots of measurements and parameters for each observation. The last line has some missing values. This is because you need points after the current point to calculate forward speed and bearing of the storm. 

Here is the full code for this function:

```{r}
stormwindmodel::add_wind_radii
```

You can see that this function is mostly wrapping helper functions, which do each step of the process. I describe these helpers (and questions I have about them) below. 

Note: 

- Because I've made this modular, it would be pretty easy to re-code any of the helper functions in C++ to increase speed. However, other than the function that uses the Newton-Raphson method, I would imagine that this step is not nearly as slow as the step that calculates wind speed at each grid point, so this might be lower priority for shifting to C++. I have an undergrad who is looking into which helper functions throughout the package we might want to write in C++ to improve performance. 

### Calculate the storm's forward speed

The first step is to determine the speed that the storm is moving forward (translational speed), in meters per second. We want to remove this from the observed maximum wind speed to get an estimate of the maximum wind speed associated just with the rotational movement of the storm, which is what needs to go into the Willoughby model [@willoughby2006parametric]. This asymmetry needs to be removed before we convert winds to gradient level. We will add back in a forward motion component to the surface winds at grid points near the end of the the modeling process.

In the new code, I'm using the Haversine method with great circle distance to calculate the distance, in kilometers, between the storm's latitude and longitude coordinates for the current observation and the following observation. I then get the time difference between those two points. From these, I estimate the storm's forward (translational) velocity. I convert to get this speed to meters per second (from kilometers per hour), so it's in the same units as $V_{max}$ from the imputed storm tracks.

Here is the equation I use for the Haversine method with great circle distance to calculate the distance (in kilometers) between the two locations based on their latitudes and longitudes. 

$$
hav(\gamma) = hav(\phi_1 - \phi_2) + cos(\phi_1)*cos(\phi_2)*hav(L_1 - L_2)
$$
$$
D = R_{earth} * \gamma 
$$

where:

- $\phi_{1,rad}$: Latitude of first location, in radians
- $L_{1,rad}$: Longitude of first location, in radians
- $\phi_{2,rad}$: Latitude of second location, in radians
- $L_{2,rad}$: Longitude of second location, in radians
- $\gamma$: Intermediary result
- $hav(\gamma)$: The haversine function, $hav(\gamma) = sin^2 \left(\frac{\gamma}{2}\right)$
- $R_{earth}$: Radius of the earth, here assumed to be 6378.14 kilometers
- $D$: Distance between the two locations, in kilometers

In the package, first we've got a helper function to convert between degrees and radians (`degrees_to_radians`), and then a function called `latlon_to_km` that uses the haversine approach to calculate the distance between two storm center locations (`tclat_1` and `tclat_2` are the two storm center latitudes; `tclon_1` and `tclon_2` are the two storm center longitudes):

```{r}
stormwindmodel:::degrees_to_radians
stormwindmodel:::latlon_to_km
```

We then have a function called `calc_forward_speed` that caculates the distance between two latitude-longitude pairs, calculates the time difference in their time stamps, and from that determines the forward speed in kilometers per hour and converts it to meters per second. 

```{r}
stormwindmodel:::calc_forward_speed
```

### Calculate direction of storm movement

Next, we need to calculate the direction of the motion of the storm (storm bearing). Later, we'll use this to add back in a component for the forward motion of the storm into the wind estimates. 

I found an equation for calculating the bearing of one point from another point based on latitude and longitude. So, this is calculating the bearing of a later storm observation, as seen from an earlier storm observation. The function also restricts the output to be between 0 and 360 degrees using modular arithmetic (`%% 360`). 

$$
S = cos(\phi_{2,rad}) * sin(L_{1,rad} - L_{2,rad})
$$

$$
C = cos(\phi_{1,rad}) * sin(\phi_{2,rad}) - sin(\phi_{1,rad}) * cos(\phi_{2,rad}) * cos(L_{1,rad} - L_{2,rad})
$$

$$
\theta = atan2(S, C) * \frac{180}{\pi} + 90
$$

where: 

- $\phi_{1,rad}$: Latitude of first location, in radians
- $L_{1,rad}$: Longitude of first location, in radians
- $\phi_{2,rad}$: Latitude of second location, in radians
- $L_{2,rad}$: Longitude of second location, in radians
- $S$, $C$: Intermediary results
- $\theta$ is the direction of the storm movement, in degrees

This is implemented in our package through the `calc_bearing` function:

```{r}
stormwindmodel::calc_bearing
```

### Calculate u- and v-components of forward speed

Next, we use the estimated magnitude and direction of the storm's forward speed to calculate u- and v-components of this forward speed. Later, we will add back in these two components to the modeled surface wind speed at grid points, after adjusting for the Phadke correction factor for forward motion [@phadke2003modeling].

To calculate the u- and v-components of forward motion, $V_{F,u}$ and $V_{F,v}$, the function uses: 

$$
V_{F,u} = \left|\overrightarrow{V_{F}}\right| cos(\theta)
$$

$$
V_{F,v} = \left|\overrightarrow{V_{F}}\right| sin(\theta)
$$

where $\theta$ is the direction of the storm movement (0 for due east, 90 for due north, etc.).

### Adjust wind speed to remove forward motion of storm

Next, there's a function called `remove_forward_speed` that uses the estimated forward speed in equation 12 (and accompanying text) from Phadke et al. [-@phadke2003modeling] to adjust wind speed to remove the component from forward motion. 

Because here the code is adjusting the maximum sustained wind to remove the component from forward speed, we can assume that we are adjusting wind speed at the radius of maximum winds and for winds blowing in the same direction as the direction of the forward motion of the storm. Therefore, the correction term for forward motion is $U = 0.5 * V_F$ [@phadke2003modeling], or half the total forward speed of the storm. This correction factor is subtracted from the maximum sustained wind speed to remove the forward component, and because we assume that the maximum winds are blowing in the same direction as the direction of the storm's forward motion, this correction term is directly subtracted from the magnitude of the wind speed (rather than breaking into u- and v-components for a vector addition).

If $V_{max}$ after removing the forward storm motion is ever negative, the `remove_forward_speed` function resets the value to 0 m / s.

```{r}
stormwindmodel:::remove_forward_speed
```

### Convert 1-min sustained wind at 10 m to gradient level wind speed 

The extended tracks database gives maximum winds as one minute sustained wind speeds 10 meters above the ground. To make calculations easier (by not having to deal with friction), we convert the 1-minute sustained wind speeds at 10 meters (`vmax` in the created dataframe), which is what is given in the hurricane tracking data, to gradient level wind speed (`vmax_gl` in the created dataframe), using the following equation:

$$
V_{max,G} = \frac{V_{max,sym}}{f_r}
$$

where:

- $V_{max,G}$: Mean wind speed at gradient level (m / s) 
- $V_{max,sustained}$: Surface wind speed (10 meters above the water or ground) (m / s)
- $f_r$: Reduction factor for $r \le$ 100 km. At this point, we're calculating things for $r = R_{max}$.

The reduction factor come from Figure 3 of Knaff et al. [-@knaff2011automated]. We assume that $R_{max}$ is always 100 km or less. Then, $f_r$ is 0.9 if the storm's center is over water and 80% of that, 0.72, if the storm's center is over land.  

```{r}
stormwindmodel::calc_gradient_speed
```

To determine if the storm center is over land or over water, we have included a dataset with the package called `landmask`. This dataset gives locations of a grid of points in eastern US and a factor saying whether each point is over land or water:  

```{r}
data(landmask)
head(landmask)
```

We wrote a function called `check_over_land` to find the closest grid point for a storm location and determine whether the storm is over land or over water. 

```{r}
stormwindmodel:::check_over_land
```

Here is an example of applying this function to the tracks for Hurricane Floyd:

```{r fig.width = 8, fig.height = 5}
floyd_tracks$land <- mapply(stormwindmodel:::check_over_land,
                            tclat = floyd_tracks$latitude,
                            tclon = -floyd_tracks$longitude)
ggplot(landmask, aes(x = longitude - 360, y = latitude, color = land)) +
  geom_point() + 
  geom_point(data = floyd_tracks, aes(x = longitude, y = latitude, 
                                     color = NULL, shape = land)) + 
  scale_color_discrete("Land mask") + 
  scale_shape_discrete("Track over land")
```

In the `add_wind_radii` function, there is code to check whether the point is overland and then apply the proper reduction factor based on whether the point is over land or water:

```{r eval = FALSE}
over_land = mapply(check_over_land, tclat, tclon),
vmax_gl = mapply(calc_gradient_speed,
                vmax_sfc_sym = vmax_sfc_sym,
                over_land = over_land)
```

### Calculate radius of maximum wind speed 

Next, the package code calculates $R_{max}$, the radius of maximum wind speed, using Eq. 7a from Willoughby et al. [-@willoughby2006parametric]:

$$
R_{max} = 46.4 e^{- 0.0155 V_{max,G} + 0.0169\phi}
$$

where: 

- $R_{max}$: Radius from the storm center to the point at which the maximum wind occurs (km)
- $V_{max,G}$: the tangential wind component of the gradient-level maximum wind speed (m / s)
- $\phi$: Latitude, in decimal degrees

```{r}
stormwindmodel::will7a
```

### Calculate parameters for Willoughby model

Next, we calculate $X_1$, which is a parameter that we need for the Willoughby model. This is done using equation 10a from the Willoughby et al. paper [-@willoughby2006parametric]:

$$
X_1 = 317.1 - 2.026V_{max,G} + 1.915 \phi
$$

where: 

- $X_1$: Parameter for Willoughby wind model
- $V_{max,G}$: Maximum gradient-level 1-min sustained wind
- $\phi$: Latitude, in decimal degrees

```{r}
stormwindmodel::will10a
```

Next, we need to calculate another Willoughby parameter, $n$. This is done with equation 10b from the Willoughby et al. paper [-@willoughby2006parametric]:

$$
n = 0.4067 + 0.0144 V_{max,G} - 0.0038 \phi
$$

where: 

- $n$: the exponential for the power law inside the eye
- $V_{max,G}$: Maximum gradient-level 1-min sustained wind
- $\phi$: Latitude, in decimal degrees

```{r}
stormwindmodel::will10b
```

Next, we need to calculate another Willoughby parameter, $A$. We do that with equation 10c from the Willoughby et al. paper [-@willoughby2006parametric]:

$$
A = 0.0696 + 0.0049 V_{max,G} - 0.0064 \phi
$$
$$
A = \begin{cases}
0 & \text{ if } A < 0\\ 
 A & \text{ otherwise }
\end{cases}
$$

where: 

- $A$: A parameter for the Willoughby model: "the fitted contribution of the faster exponential to the profile" (Willoughby, p.110)
- $V_{max,G}$: Maximum gradient-level 1-min sustained wind
- $\phi$: absolute value of latitude (degrees)

```{r}
stormwindmodel::will10c
```

### Determine radius to start of transition region

Now, for the Willoughby model, we need to use a numerical method to determine the value of $R_1$, the radius to the start of the transition region, for the storm for a given track observation. To do that, we need to find the root of this equation: 

$$
w - \frac{n ((1 - A) X_1 + 25 A)}{n ((1 - A) X_1 + 25 A) + R_{max}} = 0
$$

where: 

- $w$: the weighting function (a function of $R_{max}$, $R_1$, and $R_2 - R_1$)
- $n$: A parameter for the Willoughby model: the exponent for the power law inside the eye 
- $R_{max}$: radius at which the maximum wind occurs (km)
- $A$: "the fitted contribution of the faster exponential to the profile" [@willoughby2006parametric, p.110]
- $X_1$: A parameter for the Willoughby model: fitted slower exponential decay length in the outer vortex (km, I think)
- $X_2$: A parameter for the Willoughby model: "the fixed rapid decay length" [@willoughby2006parametric, p.1110]. From Willoughby p. 1110--1111: "We selected the most rapid decay length that seemed physically reasonable, 25 km."

The weighting function, $w$, is: 

$$
w = \begin{cases}
0 & \text{if } \xi < 0 \\ 
126 \xi^5 - 420 \xi^6 + 540 \xi^7- 315 \xi^8 + 70 \xi^9 & \text{if } 0 \le \xi \le 1\\
 1 & \text{if } \xi > 0
\end{cases}
$$

where: 

$$
\xi = \frac{R_{max} - R_1}{R_2 - R_1}
$$

and where: 

- $w$: The weighting function
- $\xi$: A nondimensional argument
- $R_{max}$: radius at which the maximum wind occurs (km)
- $R_1$: lower boundary of the transition zone (in km from the storm center)
- $R_2$: upper boundary of the transition zone (in km from the storm center)

To find the root of this equation, the package has a function that uses the Newton-Raphson method [@press2002numerical; @jones2014introduction]. This function starts with an initial guess of the root, $x_0$, then calculates new values of $x_{n+1}$ using:

$$
x_{n+1} = x_n - \frac{f(x_n)}{f'(x_n)}
$$

This process iterates until either the absolute value of $f(x_{n+1})$ is smaller than some threshold ($\epsilon$; default of 0.001 in our function) or the maximum allowed number of iterations is reached (default of 100 iterations in our function).

In this case, we're using it to try to find the value of $\xi$ that is a root of the following function: 

$$
f(\xi) = 126 \xi^5 - 420 \xi^6 + 540 \xi^7- 315 \xi^8 + 70 \xi^9 - \frac{n ((1 - A) X_1 + 25 A)}{n ((1 - A) X_1 + 25 A) + R_{max}}
$$

The derivative of this function, which is also needed for the Newton-Raphson method, is:

$$
f'(\xi) = 5 * 126 \xi^4 - 6 * 420 \xi^5 + 7 * 540 \xi^6 - 8 * 315 \xi^7 + 9 * 70 \xi^8 
$$

```{r}
stormwindmodel::will3_right
stormwindmodel::will3_deriv_func
stormwindmodel::solve_for_xi
```

Notes: 

- This function uses $x_0 = 0.5$ as a starting value. If the function has a local minimum closer to 0.5 than the global minimum, then this function would find that local minimum instead of the global minimum.
- This function prints a warning if the algorithm doesn't converge for an observation in the hurricane tracks. It also sets $\xi$ to be missing (`NA`) if the algorithm doesn't converge. 

Now an equation from the Willoughby et al. 2006 paper can be used to calculate $R_1$ [@willoughby2006parametric]:

$$
R_1 = R_{max} - \xi(R_2 - R_1)
$$

For this function, the package code assumes that $R_2 - R_1$ (the width of the transition region) is 25 kilometers when $R_{max}$ is larger than 20 kilometers and 15 kilometers otherwise.

```{r}
stormwindmodel::calc_R1
```

### Determine radius of end of transition region

Next, we estimate the radius to the end of the transition period, $R_2$. We assume that smaller storms ($R_{max} \le 20\mbox{ km}$) had a transition region of 15 km while larger storms ($R_{max} > 20\mbox{ km}$) have a transition region of 25 km:

$$
R_2 = \begin{cases}
R_1 + 25 & \text{ if } R_{max} > 20\mbox{ km}\\ 
R_1 + 15 & \text{ if } R_{max} \le 20\mbox{ km}
\end{cases}
$$

where: 

- $R_1$: Radius to the start of the transition region (km)
- $R_2$: Radius to the end of the transition region (km)

## Calculate wind speed at each grid point 

Next, the following function models the wind speed at a location, like a county center. As a note, this function calculates wind characteristics at a single location; a later function applies this to all grid points):

```{r}
stormwindmodel::calc_grid_wind
```

Again, this function uses a lot of helper functions for each step. As an input, this function requires both the dataframe output from `add_wind_radii` (which gives all of the parameters for the Willoughby model at each point on the storm's track) and also a location (latitude and longitude) to model winds. To work well with later functions, this location information should be input as a one-row dataframe rather than a vector. The `grid_point` input might therefore look something like this:

```{r echo = FALSE}
data(county_points)
county_points[1, ]
```

The package includes a dataset called `county_points` that has the population mean centers of each county in hurricane-prone states. This dataset can be used directly from the package to determine county-level exposures.

The `grid_point` input must follow a specific format. The column names for latitude and longitude must be `glat` and `glon`, both should be in decimal degrees, and the longitude should be expressed using negative numbers for the Western hemisphere.

Here is an example of running the `calc_grid_wind` function, as well as the typical output from the function. Notice that the function only outputs wind estimates for one grid point at a time; in this example, the point is for Dare County, NC, (FIPS 37055) during Hurricane Floyd:

```{r}
grid_point <- county_points %>% filter(gridid == "37055")
grid_wind <- calc_grid_wind(grid_point = grid_point,
                            with_wind_radii = with_wind_radii)
grid_wind %>% slice(1:5)
```

Here is a plot of modeled sustained surface winds in Dare County by time:

```{r warning = FALSE, fig.width = 6, fig.align = "center"}
ggplot(grid_wind, aes(x = date, y = windspeed)) + 
  geom_line() + 
  xlab("Observation time") + 
  ylab("Modeled surface wind (m / s)")
```

You can also apply this function across all grid points for all time to create a large dataset with the estimated wind speed at each county at each observation point. For example, you could run this for Floyd and then plot winds at particular time "snap shots" using the following code: 

```{r fig.width = 8}
county_list <- split(county_points, f = county_points$gridid)
county_winds <- lapply(county_list, FUN = calc_grid_wind,
                       with_wind_radii = with_wind_radii)
names(county_winds) <- county_points$gridid
county_winds <- bind_rows(county_winds, .id = "gridid")

county_winds %>%
  filter(date == "1999-09-16 08:00:00 UTC") %>%
  map_wind(value = "windspeed")
```

After calculating the grid wind time series for a grid point, you can input the time series for a grid point into `summarize_grid_wind` to generate overall storm summaries for the grid point. This functions calculate wind characteristics at each grid point (or county center location) for every storm observation. These characteristics are: 

- `vmax_gust`: Maximum value of surface-level (10 meters) sustained winds, in meters per second, over the length of the storm at the given location
- `vmax_sust`: Maximum value of surface-level (10 meters) gust winds, in meters per second, over the length of the storm at the given location
- `gust_dur`: Length of time, in minutes, that surface-level sustained winds were above a certain wind speed cutoff (e.g., 20 meters per second)
- `sust_dur`: Length of time, in minutes, that surface-level gust winds were above a certain wind speed cutoff (e.g., 20 meters per second) 

```{r}
stormwindmodel::summarize_grid_wind
```

This function inputs the grid wind time series for a grid point and outputs the summary statistics for that grid point: 

```{r}
summarize_grid_wind(grid_wind = grid_wind)
```

If you want, you can change the cutoffs you're using for the duration measurements: 

```{r}
summarize_grid_wind(grid_wind = grid_wind, gust_duration_cut = 15, 
                    sust_duration_cut = 15)
```

The function `calc_and_summarize_grid_wind` combines these two actions (this is mainly useful to have for the main wrapper function for the package): 

```{r}
stormwindmodel:::calc_and_summarize_grid_wind(grid_point = grid_point,
                            with_wind_radii = with_wind_radii,
                            gust_duration_cut = 15, 
                            sust_duration_cut = 15)
```

The `calc_grid_wind` function uses a number of helper functions. They are described in more detail below.

### Get the radius from the storm center to the grid point

The first step is to determine the distance between the grid point and the center of the storm ($C_{dist}$). This is done using the Haversine method of great circle distance to calculate this distance. For this, the package uses the `latlon_to_km` function given in the code shown above.

### Determine gradient wind speed at each location

Next, the package calculates $V_G(r)$, the gradient level 1-minute sustained wind at the grid point, which is at radius $r$ from the tropical cyclone center ($C_{dist}$ for the grid point). Note there are different equations for $V_G(r)$ for (1) the eye to the start of the transition region; (2) outside the transition region; and (3) within the transition region.

First, if $r \le R_1$ (inside the transition region), you are supposed to use this equation to calculate $V_G(r)$ (Willoughby et al. Eqn 1 (a) [-@willoughby2006parametric]):

$$
V_G(r) = V_i = V_{max,G} \left( \frac{r}{R_{max}} \right)^n, (0 \le r \le R_1)
$$

Next, if $r \ge R_2$ (outside the transition region), you are suppose to use this equation to calculate $V(r)$ using this equation (Willoughby et al. 2006, Eqn 4; dual-exponential replacement of Eqn 1 (b) [-@willoughby2006parametric]):

$$
V_G(r) = V_o = V_{max,G}\left[(1 - A) e^\frac{R_{max} - r}{X_1} + A e^\frac{R_{max} - r}{X_2}\right], R_2 < r
$$

Finally, if $r$ for the grid point is between $R_1$ and $R_2$, we need to calculate $\xi$ using the value we calculated for $r$ for the grid point: 

$$
\xi = \frac{r - R_1}{R_2 - R_1}
$$

and then: 

$$
w = \begin{cases}
0 & \text{if } \xi < 0 \\ 
126 \xi^5 - 420 \xi^6 + 540 \xi^7- 315 \xi^8 + 70 \xi^9 & \text{if } 0 \le \xi \le 1\\
 1 & \text{if } \xi > 0
\end{cases}
$$

where: 

- $w$: Weighting variable
- $\xi$: A nondimensional argument
- $r$: radius from the storm center to the grid point (in km)
- $R_{max}$: radius at which the maximum wind occurs (km)
- $R_1$: lower boundary of the transition zone (in km from the storm center)
- $R_2$: upper boundary of the transition zone (in km from the storm center)

Willoughby et al. 2006, Eqn 1 (c) [-@willoughby2006parametric]:

$$
V_G(r) = V_i (1 - w) + V_o w, (R_1 \le r \le R_2)
$$

All of this is wrapped in the `will1` function (named after the equation in Willoughby et al. [-@willoughby2006parametric]):

```{r}
stormwindmodel:::will1
```

### Estimate surface level winds from gradient winds

Now, to get estimated surface-level tangential winds from gradient-levels winds, we reverse what we did before, again using methods from Knaff et al. [-@knaff2011automated]. 

In this case, we can always assume we're over land, not water, so we always reduce the reduction factor by 20%. Now, however, we cannot assume that $r$ is always $R_{max}$, so we need to include a function that calculates the reduction factor as a function of radius from the storm center.

For this, we use values from Figure 3 in Knaff et al. [-@knaff2011automated]. This method uses a reduction factor of 0.90 up to a radius of 100 km, a reduction factor of 0.75 for any radius 700 km or greater, and a linear decreasing reduction factor for any radius between those two radius values. If the point is over land (true for any county), this reduction factor is further reduced by 20%.

Here is the function we use for this part:

```{r}
stormwindmodel:::gradient_to_surface
```

Here is a reproduction of part of Figure 3 from Knaff et al. [-@knaff2011automated] using this function:
 
```{r, fig.align = "center", fig.width = 4, fig.height = 2.5}
rf_example <- data.frame(r = 0:800,
                         rf = mapply(
                           stormwindmodel:::gradient_to_surface, 
                           wind_gl_aa = 1, cdist = 0:800))
ggplot(rf_example, aes(x = r, y = rf)) + 
  geom_line() + 
  theme_minimal() + 
  xlab("Radius (km)") + 
  ylab("Reduction factor") + 
  ylim(c(0.5, 0.9))
```

### Calculate the direction of gradient winds at each location 

So far, the model has just calculated the the rotational component of the wind speed at each grid location (tangential wind). Now we need to add back in asymmetry from the forward motion component of the wind speed (translational wind) at each location. The total storm winds will be increased by forward motion of the storm on the right side of the storm. Conversely, on the left side of the storm, the forward motion of the storm will offset some of the storm-related wind. 

We've already determined the direction of the forward direction of the storm. Now, we need to get the direction of the storm winds at each location we want to assess (grid points or counties).

First, the function determine, for each storm location, the direction from the storm center to the locations. For this, the package uses the `calc_bearing` function described earlier to determine the bearing of the storm at each storm observation. Now, it is used to calculate the angle from the storm center to the grid point:

```{r}
stormwindmodel:::calc_bearing
```

Next, the function calculates the gradient wind direction based on the bearing of a location from the storm. This gradient wind direction is calculated by adding 90 degrees to the bearing of the grid point from the storm center.

```{r eval = FALSE}
gwd = (90 + chead) %% 360
```

### Calculate the surface wind direction

The next step is to change from the gradient wind direction to the surface wind direction. To do this, the function adds an inflow angle to the gradient wind direction (making sure the final answer is between 0 and 360 degrees). This step is necessary because surface friction changes the wind direction a bit near the surface compared to higher above the surface.

The inflow angle is calculated as a function of the distance from the storm center to the location and the storm's $R_{max}$ at that observation point [eq. 11a--c, @phadke2003modeling]:

$$
\beta = \begin{cases}
 & 10 + \left(1 + \frac{R}{R_{max}}\right) \text{ if } R < R_{max}\\ 
 & 20 + 25\left(\frac{R}{R_{max}} - 1 \right ) \text{ if } R_{max} \le R \le 1.2R_{max}\\ 
 & 25 \text{ if } R \ge 1.2R_{max}
\end{cases}
$$

Over land, the inflow angle should be about 20 degrees more than it is over water. Therefore, after calculating the inflow angle from the equation above, the function adds 20 degrees to the value since all modeled locations are over land. The final calculation, then, is:

$$
swd = gwd + \beta + 20
$$

Here is the new function for this step:

```{r}
add_inflow
```

### Add back in wind component from forward speed of storm

Next, to add back in the storm's forward motion at each grid point, the code reverses the earlier step that used the Phadke correction factor [equation 12, @phadke2003modeling]. The package calculates a constant correction factor (`correction_factor`), as a function of `r`, radius from the storm center to the grid point, and `R_{max}`, radius from storm center to maximum winds. Both the u- and v-components of forward speed are corrected with this correction factor, then these components are added to the u- and v-components of tangential surface wind. These u- and v-components are then used to calculate the magnitude of total wind associated with the storm at the grid point:

```{r}
stormwindmodel:::add_forward_speed
```

### Calculate 3-second gust wind speed from sustained wind speed

The last step in the code calculates gust wind speed from sustained wind speed by applying a gust factor:

$$
V_{sfc,gust} = G_{3,60}*V_{sfc}
$$

where $V_{sfc}$ is the asymmetric surface wind speed, $V_{sfc,gust}$ is the surface gust wind speed, and $G_{3,60}$ is the gust factor.

Here is a table with gust factors based on location [@harper2010guidelines]: 

```{r echo = FALSE}
gust_factors <- data.frame(loc = c("In-land", 
                                   "Just offshore",
                                   "Just onshore",
                                   "At sea"),
                           gust_factor = c(1.49, 1.36, 1.23, 1.11))
knitr::kable(gust_factors, col.names = c("Location", "Gust factor ($G_{3,60}$)"))
```

The `stormwindmodel` package uses the "in-land" gust factor value throughout.

```{r eval = FALSE}
gustspeed = windspeed * 1.49
```

## Putting everything together

There's a wrapper function called `get_grid_winds` that puts everything together. As inputs, it takes the storm tracks and the grid point locations. It outputs a dataframe like this: 

```{r cache = TRUE}
data("hurr_tracks", package = "hurricaneexposuredata")
grid_winds_katrina <- get_grid_winds(hurr_track = subset(hurr_tracks,
                                                  storm_id == "Katrina-2005"),
                                     grid_df = county_points)
```

Here is what the start of that dataset looks like: 

```{r}
head(grid_winds_katrina)
```

with the maxmium sustained and gust wind speeds (in meters per second) and duration of winds over 20 meters per second for each wind type (this cutoff point can be customized with the `gust_duration` and `sust_duration` arguments) added for each grid point.

Here is the code for this function: 

```{r}
get_grid_winds
```

There is also a function to map county-level estimates. For this function to work, winds must be modeled at county centers, with FIPS codes used as the grid ids. Here's an example of calculating and mapping county winds for Katrina:

```{r fig.width = 7, fig.height = 4, warning = FALSE, message = FALSE}
a <- map_wind(grid_winds_katrina, value = "vmax_gust") + 
  ggtitle("Maximum gust wind speeds")
hurricaneexposure::map_tracks("Katrina-2005", plot_object = a)
```

```{r fig.width = 7, fig.height = 4, warning = FALSE, message = FALSE}
a <- map_wind(grid_winds_katrina, value = "vmax_sust") + 
  ggtitle("Maximum sustained wind speeds")
hurricaneexposure::map_tracks("Katrina-2005", plot_object = a)
```

```{r fig.width = 7, fig.height = 4, warning = FALSE, message = FALSE}
# Show in knots
a <- map_wind(grid_winds_katrina, value = "vmax_gust",
              wind_metric = "knots") + 
  ggtitle("Maximum gust wind speeds")
hurricaneexposure::map_tracks("Katrina-2005", plot_object = a)
```

```{r fig.width = 7, fig.height = 4, warning = FALSE, message = FALSE}
a <- map_wind(grid_winds_katrina, value = "vmax_sust",
              wind_metric = "knots") + 
  ggtitle("Maximum sustained wind speeds")
hurricaneexposure::map_tracks("Katrina-2005", plot_object = a)
```

```{r fig.width = 7, fig.height = 4, warning = FALSE, message = FALSE}
# Sustained winds of 20 m / s or more
a <- map_wind(grid_winds_katrina, value = "vmax_sust", 
         break_point = 20)
hurricaneexposure::map_tracks("Katrina-2005", plot_object = a)
```

```{r fig.width = 7, fig.height = 4, warning = FALSE, message = FALSE}
# Sustained winds of 34 knots or more
a <- map_wind(grid_winds_katrina, value = "vmax_sust", wind_metric = "knots", 
         break_point = 34)
hurricaneexposure::map_tracks("Katrina-2005", plot_object = a)
```

```{r fig.width = 7, fig.height = 4, warning = FALSE, message = FALSE}
# Sustained winds of 50 knots or more
a <- map_wind(grid_winds_katrina, value = "vmax_sust", wind_metric = "knots", 
         break_point = 50)
hurricaneexposure::map_tracks("Katrina-2005", plot_object = a)
```

```{r fig.width = 7, fig.height = 4, warning = FALSE, message = FALSE}
# Sustained winds of 64 knots or more
a <- map_wind(grid_winds_katrina, value = "vmax_sust", wind_metric = "knots", 
         break_point = 64)
hurricaneexposure::map_tracks("Katrina-2005", plot_object = a)
```

# References
